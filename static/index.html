<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manyfold Processor | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: radial-gradient(circle at top left, #0f172a, #020617);
            color: #f8fafc;
        }

        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }

        .accent-gradient {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        }

        .card-hover:hover {
            transform: translateY(-4px);
            border-color: rgba(59, 130, 246, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes pulse-subtle {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .status-pulse {
            animation: pulse-subtle 2s infinite ease-in-out;
        }
    </style>
</head>

<body class="min-h-screen pb-12">
    <!-- Navigation -->
    <nav class="glass sticky top-0 z-50 px-6 py-4 flex justify-between items-center border-b border-white/10">
        <div class="flex items-center gap-3">
            <div
                class="w-10 h-10 accent-gradient rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5" />
                </svg>
            </div>
            <div>
                <h1 class="text-xl font-bold tracking-tight">Manyfold Processor</h1>
                <p class="text-[10px] text-blue-400 font-semibold uppercase tracking-widest">Rust Powered Engine</p>
            </div>
        </div>
        <div class="flex items-center gap-6">
            <div
                class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-emerald-500/10 border border-emerald-500/20">
                <div class="w-2 h-2 rounded-full bg-emerald-500 status-pulse"></div>
                <span class="text-xs font-semibold text-emerald-400">Engine Online</span>
            </div>
            <button class="glass p-2 rounded-lg hover:bg-white/10 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
        </div>
    </nav>

    <main class="container mx-auto mt-12 px-6">
        <!-- Stats Row -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
            <div class="glass p-6 rounded-2xl">
                <p class="text-sm text-gray-400 mb-1">Queue Depth</p>
                <div class="flex items-end gap-2">
                    <h3 class="text-4xl font-bold" id="queue-count">0</h3>
                    <span class="text-blue-400 text-sm mb-1">Models</span>
                </div>
            </div>
            <div class="glass p-6 rounded-2xl">
                <p class="text-sm text-gray-400 mb-1">System Load</p>
                <div class="flex items-end gap-2">
                    <h3 class="text-4xl font-bold" id="system-load">-</h3>
                    <span class="text-emerald-400 text-sm mb-1">Avg 1m</span>
                </div>
            </div>
            <div class="glass p-6 rounded-2xl">
                <p class="text-sm text-gray-400 mb-1">Memory Usage</p>
                <div class="flex items-end gap-2">
                    <h3 class="text-4xl font-bold" id="memory-usage">-</h3>
                    <span class="text-violet-400 text-sm mb-1">MB</span>
                </div>
            </div>
            <div class="glass p-6 rounded-2xl">
                <p class="text-sm text-gray-400 mb-1">Processed Today</p>
                <div class="flex items-end gap-2">
                    <h3 class="text-4xl font-bold" id="processed-count">0</h3>
                    <span class="text-orange-400 text-sm mb-1">Items</span>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
            <!-- Left: Intake Queue -->
            <div class="lg:col-span-2 space-y-8">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Intake Queue</h2>
                    <div class="flex gap-4">
                        <button
                            class="px-4 py-2 rounded-lg glass hover:bg-white/10 transition-colors text-sm font-semibold">
                            Refresh List
                        </button>
                        <button
                            class="px-4 py-2 rounded-lg accent-gradient shadow-lg shadow-blue-500/20 text-sm font-bold">
                            Process All
                        </button>
                    </div>
                </div>

                <div class="glass rounded-3xl overflow-hidden border border-white/5">
                    <div
                        class="bg-white/5 px-8 py-4 grid grid-cols-[1fr_100px_100px_140px] gap-4 border-b border-white/10 mb-2 text-xs font-bold text-gray-500 uppercase tracking-widest">
                        <span>FILENAME</span>
                        <span>TYPE</span>
                        <span>STATUS</span>
                        <span class="text-right">ACTION</span>
                    </div>

                    <div class="p-2 space-y-1 max-h-[500px] overflow-y-auto custom-scrollbar" id="queue-list">
                        <!-- Queue items will be injected here -->
                    </div>

                    <div class="p-8 text-center border-t border-white/5 mt-4">
                        <p class="text-sm text-gray-500 italic">No more items in staging. System observing `/input`
                            volume.</p>
                    </div>
                </div>
            </div>

            <!-- Right: Activity & Setup -->
            <div class="space-y-8">
                <h2 class="text-2xl font-bold">System Status</h2>

                <div class="glass p-6 rounded-3xl space-y-6">
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-sm font-semibold">Auto-Processor</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="auto-toggle" class="sr-only peer">
                                <div
                                    class="w-11 h-6 bg-white/10 rounded-full peer peer-checked:after:translate-x-full peer-checked:bg-blue-600 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all">
                                </div>
                            </label>
                        </div>
                        <p class="text-xs text-gray-500 leading-relaxed">
                            When enabled, the engine automatically begins processing files once they have settled for 2s
                            in the intake volume.
                        </p>
                    </div>

                    <div class="pt-6 border-t border-white/10">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-sm font-semibold">Live Timeline</span>
                            <button id="clear-timeline-btn"
                                class="text-[10px] text-gray-500 hover:text-red-400 transition-colors uppercase font-bold tracking-widest border border-white/5 px-2 py-0.5 rounded bg-white/5">
                                Clear
                            </button>
                        </div>
                        <div class="space-y-4 font-mono" id="timeline">
                            <div class="flex gap-3 text-[10px]">
                                <span class="text-gray-500">SYSTEM</span>
                                <span class="text-blue-400">READY</span>
                                <span class="text-gray-300">Web UI Initialized. Waiting for events...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass p-6 rounded-3xl">
                    <div class="flex items-center gap-3 mb-4">
                        <div
                            class="w-8 h-8 rounded-lg bg-orange-500/20 flex items-center justify-center text-orange-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <span class="text-sm font-bold">System Info</span>
                    </div>
                    <p class="text-[11px] text-gray-400 leading-normal">
                        Tier 1 (Mock) execution environment detected.
                    </p>
                </div>
            </div>
        </div>
    </main>

    <script>
        console.log("Manyfold Processor UI Initialized");

        // Gear Button Logic
        function showSettings() {
            alert("System Configuration:\n\nMode: Tier 1 (Mock)\nAPI: Connected\nLog Level: INFO\n\nFull settings panel coming in v0.6");
        }
        // Attach to gear button
        document.querySelector('button.glass').onclick = showSettings;

        // Auto-Processor Toggle Logic
        const toggle = document.getElementById('auto-toggle');
        let togglePending = false;

        toggle.onchange = async () => {
            togglePending = true;
            const newValue = toggle.checked;
            try {
                const response = await fetch('/api/config/auto-process', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: newValue })
                });
                const data = await response.json();
                console.log("Auto-Process set to:", data.enabled);
                toggle.checked = data.enabled; // Sync with server response
            } catch (e) {
                console.error("Toggle failed", e);
                toggle.checked = !newValue; // Revert on fail
            } finally {
                togglePending = false;
            }
        };

        async function fetchStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                document.getElementById('queue-count').innerText = data.queue_count;
                document.getElementById('processed-count').innerText = data.processed_count;

                // New Real Metrics
                document.getElementById('system-load').innerText = data.system_load.toFixed(1) + '%';
                document.getElementById('memory-usage').innerText = data.memory_usage;

                // Sync Toggle State only if not being interacted with
                if (!togglePending) {
                    toggle.checked = data.auto_process_enabled;
                }

                // Render Queue Items
                const queueList = document.getElementById('queue-list');
                if (data.queue_items && data.queue_items.length > 0) {
                    queueList.innerHTML = data.queue_items.map(item => {
                        const name = item.toLowerCase();
                        let type = 'Asset';
                        let typeClass = 'bg-blue-500/10 text-blue-400';

                        if (name.endsWith('.3mf')) {
                            type = 'Package';
                            typeClass = 'bg-violet-500/10 text-violet-400';
                        } else if (name.endsWith('.stl')) {
                            type = 'Model';
                            typeClass = 'bg-emerald-500/10 text-emerald-400';
                        }

                        return `
                        <div class="px-4 py-3 grid grid-cols-[1fr_100px_100px_140px] gap-4 items-center hover:bg-white/5 transition-colors group rounded-xl">
                            <span class="text-sm font-medium text-gray-300 truncate">${item}</span>
                            <span class="px-2 py-0.5 rounded-md ${typeClass} text-[10px] font-bold uppercase tracking-wider text-center w-fit">
                                ${type}
                            </span>
                            <span class="flex items-center gap-2 text-xs font-semibold text-gray-500">
                                <div class="w-1.5 h-1.5 rounded-full bg-blue-500 status-pulse"></div>
                                Staged
                            </span>
                            <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="deleteFile('${item}')" class="p-1.5 rounded-lg hover:bg-red-500/10 text-red-400/60 hover:text-red-400 transition-colors" title="Delete">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                                <button onclick="alert('Triggering process for ${item}')" class="px-3 py-1.5 rounded-lg border border-white/10 text-[10px] font-bold uppercase tracking-widest hover:bg-white/10 transition-colors">
                                    Process
                                </button>
                            </div>
                        </div>
                    `}).join('');
                } else {
                    queueList.innerHTML = '';
                }

                // Render Timeline
                const timeline = document.getElementById('timeline');
                if (data.timeline_events && data.timeline_events.length > 0) {
                    timeline.innerHTML = data.timeline_events.slice().reverse().map(event => {
                        const [type, ...rest] = event.split(': ');
                        const desc = rest.join(': ');
                        return `
                            <div class="flex gap-3 text-[10px]">
                                <span class="text-gray-500">${new Date().toLocaleTimeString([], { hour12: false })}</span>
                                <span class="text-blue-400 font-bold">${type.toUpperCase()}</span>
                                <span class="text-gray-300">${desc}</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    timeline.innerHTML = `
                        <div class="flex gap-3 text-[10px]">
                            <span class="text-gray-500">SYSTEM</span>
                            <span class="text-blue-400">READY</span>
                            <span class="text-gray-300">Web UI Initialized. Waiting for events...</span>
                        </div>`;
                }

            } catch (error) {
                console.error('Error fetching status:', error);
            }
        }

        // Poll every 2 seconds
        setInterval(fetchStatus, 2000);
        fetchStatus();

        // Clear Timeline Logic
        const clearBtn = document.getElementById('clear-timeline-btn');
        clearBtn.onclick = async () => {
            if (!confirm("Clear all timeline events?")) return;
            try {
                await fetch('/api/actions/clear-timeline', { method: 'POST' });
                document.getElementById('timeline').innerHTML = ''; // Immediate local clear
                fetchStatus(); // Refresh status counts
            } catch (e) {
                console.error("Clear failed", e);
            }
        };
        // Delete File Logic
        async function deleteFile(filename) {
            if (!confirm(`Are you sure you want to delete ${filename}?`)) return;
            try {
                const response = await fetch(`/api/actions/delete-file/${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    fetchStatus();
                } else {
                    alert("Delete failed. File may no longer exist.");
                }
            } catch (e) {
                console.error("Delete failed", e);
            }
        }
    </script>
</body>

</html>